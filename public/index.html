<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Clip Upload</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 1rem;
        background: #f8f9fa;
        line-height: 1.4;
        font-size: 14px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
      }
      .subtitle {
        margin: 0 0 1rem 0;
        color: #6b7280;
        font-size: 0.875rem;
      }
      form {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .form-grid--full {
        grid-template-columns: 1fr;
      }
      label {
        display: block;
        font-weight: 500;
        font-size: 0.8125rem;
        color: #374151;
        margin-bottom: 0.25rem;
      }
      input, textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font: inherit;
        font-size: 0.875rem;
        transition: border-color 0.15s;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #2563eb;
      }
      textarea {
        resize: vertical;
        min-height: 60px;
      }
      .hint {
        display: block;
        color: #9ca3af;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      .section-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1f2937;
        margin: 1rem 0 0.5rem 0;
        padding-bottom: 0.375rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .clip {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .clip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .clip-number {
        font-weight: 600;
        font-size: 0.8125rem;
        color: #6b7280;
      }
      .clip-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font: inherit;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }
      .btn-primary {
        background: #2563eb;
        color: #fff;
      }
      .btn-primary:hover:not(:disabled) {
        background: #1d4ed8;
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-success {
        background: #10b981;
        color: #fff;
        width: 100%;
        margin-top: 0.5rem;
      }
      .btn-success:hover {
        background: #059669;
      }
      .btn-danger {
        background: #ef4444;
        color: #fff;
        font-size: 0.75rem;
        padding: 0.25rem 0.625rem;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .response-panel {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      .response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        user-select: none;
      }
      .response-title {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
      }
      .response-badge {
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
      }
      .badge-idle { background: #f3f4f6; color: #6b7280; }
      .badge-info { background: #dbeafe; color: #1e40af; }
      .badge-success { background: #d1fae5; color: #065f46; }
      .badge-error { background: #fee2e2; color: #991b1b; }
      .response-body {
        padding: 1rem;
        max-height: 600px;
        overflow-y: auto;
      }
      .response-body.collapsed {
        display: none;
      }
      .response-empty {
        color: #9ca3af;
        font-family: ui-monospace, monospace;
        font-size: 0.8125rem;
      }
      .response-summary {
        margin: 0 0 0.75rem 0;
        font-weight: 600;
        font-size: 0.875rem;
        color: #1f2937;
      }
      .response-grid {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
      .clip-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 0.75rem;
      }
      .clip-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .clip-card-title {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1f2937;
      }
      .clip-id {
        font-size: 0.6875rem;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        background: #e0e7ff;
        color: #3730a3;
      }
      .clip-meta {
        display: grid;
        gap: 0.25rem;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
      }
      .meta-row {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .meta-label {
        color: #6b7280;
        font-weight: 500;
      }
      .meta-value {
        color: #1f2937;
        text-align: right;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .meta-value a {
        color: #2563eb;
        text-decoration: none;
      }
      .meta-value a:hover {
        text-decoration: underline;
      }
      .clip-desc {
        margin: 0;
        font-size: 0.8125rem;
        color: #4b5563;
        line-height: 1.4;
      }
      .raw-json {
        margin-top: 0.75rem;
      }
      .raw-json summary {
        cursor: pointer;
        font-weight: 500;
        font-size: 0.8125rem;
        color: #6b7280;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 4px;
      }
      .raw-json summary:hover {
        background: #f3f4f6;
      }
      pre {
        margin: 0.5rem 0 0 0;
        padding: 0.75rem;
        background: #1e293b;
        color: #10b981;
        border-radius: 4px;
        overflow-x: auto;
        font-family: ui-monospace, monospace;
        font-size: 0.75rem;
        line-height: 1.5;
      }
      @media (max-width: 768px) {
        .form-grid, .clip-grid {
          grid-template-columns: 1fr;
        }
        .response-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Clip Upload</h1>
      <p class="subtitle">Upload videos and define clip ranges for processing</p>

      <form id="clip-form">
        <div class="form-grid">
          <div>
            <label>Origin ID</label>
            <input type="text" name="origin_id" value="demo-video" required />
          </div>
          <div>
            <label>FPS</label>
            <input type="number" name="fps" min="1" max="240" value="30" required />
          </div>
        </div>

        <div class="section-title">Clips</div>
        <div id="clips-container"></div>
        <button type="button" id="add-clip" class="btn-success">+ Add Clip</button>

        <div class="section-title">Video Source</div>
        <div class="form-grid--full">
          <div>
            <label>Video File</label>
            <input type="file" name="video" accept="video/*" />
            <span class="hint">Or provide a URL below</span>
          </div>
          <div>
            <label>Video URL</label>
            <input type="url" name="video_url" placeholder="https://example.com/video.mp4" />
          </div>
        </div>

        <div class="section-title">Animation (Optional)</div>
        <div class="form-grid">
          <div>
            <label>Animation File (.bin)</label>
            <input type="file" name="animation" accept=".bin,application/octet-stream" />
          </div>
          <div>
            <label>Animation URL</label>
            <input type="url" name="animation_url" placeholder="https://example.com/anim.bin" />
          </div>
        </div>

        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Upload Clips</button>
      </form>

      <div class="response-panel">
        <div class="response-header" id="response-toggle">
          <h2 class="response-title">Response</h2>
          <span id="response-status" class="response-badge badge-idle">Awaiting</span>
        </div>
        <div id="response-body" class="response-body">
          <div class="response-empty">(awaiting request)</div>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("clip-form");
      const responseStatusEl = document.getElementById("response-status");
      const responseBodyEl = document.getElementById("response-body");
      const responseToggle = document.getElementById("response-toggle");
      const clipsContainer = document.getElementById("clips-container");
      const addClipButton = document.getElementById("add-clip");

      responseToggle.addEventListener("click", () => {
        responseBodyEl.classList.toggle("collapsed");
      });

      const setResponse = ({ status, tone = "idle", body, bodyNode, emptyClass = false }) => {
        responseStatusEl.textContent = status;
        responseStatusEl.className = `response-badge badge-${tone}`;
        responseBodyEl.innerHTML = "";
        responseBodyEl.classList.remove("collapsed");
        responseBodyEl.classList.toggle("response-empty", emptyClass);
        if (bodyNode) {
          responseBodyEl.append(bodyNode);
        } else if (body !== undefined) {
          responseBodyEl.textContent = String(body);
        }
      };

      const omitEmbeddings = (value) => {
        if (Array.isArray(value)) return value.map(omitEmbeddings);
        if (value && typeof value === "object") {
          return Object.fromEntries(
            Object.entries(value)
              .filter(([key]) => key !== "embedding")
              .map(([key, val]) => [key, omitEmbeddings(val)])
          );
        }
        return value;
      };

      const createField = (label, value) => {
        const row = document.createElement("div");
        row.className = "meta-row";
        const labelEl = document.createElement("span");
        labelEl.className = "meta-label";
        labelEl.textContent = label;
        const valueEl = document.createElement("span");
        valueEl.className = "meta-value";
        if (typeof value === "string" && /^https?:\/\//i.test(value)) {
          const link = document.createElement("a");
          link.href = value;
          link.target = "_blank";
          link.rel = "noreferrer";
          link.textContent = "→ link";
          valueEl.append(link);
        } else {
          valueEl.textContent = value ?? "—";
        }
        row.append(labelEl, valueEl);
        return row;
      };

      const formatTimestamp = (value) => {
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? value : date.toLocaleString();
      };

      const createRawJsonDetails = (data) => {
        const details = document.createElement("details");
        details.className = "raw-json";
        const summary = document.createElement("summary");
        summary.textContent = "View raw JSON";
        const pre = document.createElement("pre");
        pre.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
        details.append(summary, pre);
        return details;
      };

      const createClipCard = (clip, index) => {
        const card = document.createElement("article");
        card.className = "clip-card";

        const header = document.createElement("div");
        header.className = "clip-card-header";
        const title = document.createElement("h3");
        title.className = "clip-card-title";
        title.textContent = `Clip ${index + 1}`;
        header.append(title);

        if (clip.id !== undefined) {
          const id = document.createElement("span");
          id.className = "clip-id";
          id.textContent = `#${clip.id}`;
          header.append(id);
        }

        card.append(header);

        const meta = document.createElement("div");
        meta.className = "clip-meta";
        meta.append(
          createField("Origin", clip.origin_id),
          createField("Frames", `${clip.start_frame} → ${clip.end_frame}`),
          createField("Video", clip.video_url ?? clip.url),
          createField("Animation", clip.animation_url)
        );
        if (clip.created_at) {
          meta.append(createField("Created", formatTimestamp(clip.created_at)));
        }
        card.append(meta);

        const desc = document.createElement("p");
        desc.className = "clip-desc";
        desc.textContent = clip.description || "No description";
        card.append(desc);

        return card;
      };

      const renderResponsePayload = (payload) => {
        const sanitized = omitEmbeddings(payload);
        const stack = document.createElement("div");

        if (payload?.clips && Array.isArray(payload.clips)) {
          const summary = document.createElement("p");
          summary.className = "response-summary";
          summary.textContent = `${payload.clips.length} clip${payload.clips.length === 1 ? "" : "s"} processed`;
          stack.append(summary);

          const grid = document.createElement("div");
          grid.className = "response-grid";
          payload.clips.forEach((clip, index) => {
            grid.append(createClipCard(clip, index));
          });
          stack.append(grid);
          stack.append(createRawJsonDetails(sanitized));
          return stack;
        }

        if (payload?.error) {
          const message = document.createElement("p");
          message.className = "response-summary";
          message.textContent = String(payload.error);
          stack.append(message);
          stack.append(createRawJsonDetails(sanitized));
          return stack;
        }

        stack.append(createRawJsonDetails(sanitized));
        return stack;
      };

      const createClipElement = (initial) => {
        const wrapper = document.createElement("div");
        wrapper.className = "clip";
        const clipIndex = clipsContainer.children.length + 1;
        wrapper.innerHTML = `
          <div class="clip-header">
            <span class="clip-number">Clip ${clipIndex}</span>
            <button type="button" class="btn-danger remove-clip">Remove</button>
          </div>
          <div class="clip-grid">
            <div>
              <label>Start Frame</label>
              <input type="number" data-field="start" min="0" value="${initial.start_frame}" required />
            </div>
            <div>
              <label>End Frame</label>
              <input type="number" data-field="end" min="1" value="${initial.end_frame}" required />
            </div>
          </div>
          <div>
            <label>Description</label>
            <textarea data-field="description" required>${initial.description}</textarea>
          </div>
        `;
        wrapper.querySelector(".remove-clip").addEventListener("click", () => {
          wrapper.remove();
          syncClipNumbers();
        });
        return wrapper;
      };

      const syncClipNumbers = () => {
        const clipEls = clipsContainer.querySelectorAll(".clip");
        clipEls.forEach((clipEl, idx) => {
          clipEl.querySelector(".clip-number").textContent = `Clip ${idx + 1}`;
          const btn = clipEl.querySelector(".remove-clip");
          btn.disabled = clipEls.length === 1;
        });
      };

      const addClip = (initial) => {
        const defaults = (() => {
          if (initial) return initial;
          const lastClip = clipsContainer.lastElementChild;
          if (!lastClip) {
            return { start_frame: 0, end_frame: 90, description: "Opening title card" };
          }
          const lastEnd = Number(lastClip.querySelector('[data-field="end"]').value || 0);
          return { start_frame: lastEnd, end_frame: lastEnd + 60, description: "New clip" };
        })();
        clipsContainer.appendChild(createClipElement(defaults));
        syncClipNumbers();
      };

      addClipButton.addEventListener("click", () => addClip());
      addClip();

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const submitButton = form.querySelector("button[type=submit]");
        submitButton.disabled = true;
        submitButton.textContent = "Uploading...";

        try {
          setResponse({ status: "Validating", tone: "info", body: "Checking form data..." });

          const formData = new FormData();
          const videoFile = form.video.files[0];
          const animationFile = form.animation.files[0];
          const videoUrl = form.video_url.value.trim();
          const animationUrl = form.animation_url.value.trim();

          if (!videoFile && !videoUrl) {
            throw new Error("Upload a video file or enter a Video URL");
          }

          const clipEls = clipsContainer.querySelectorAll(".clip");
          const clips = Array.from(clipEls).map((clipEl) => ({
            start_frame: Number(clipEl.querySelector('[data-field="start"]').value),
            end_frame: Number(clipEl.querySelector('[data-field="end"]').value),
            description: clipEl.querySelector('[data-field="description"]').value.trim(),
          }));

          const payload = {
            origin_id: form.origin_id.value.trim(),
            fps: Number(form.fps.value),
            clips,
          };
          if (videoUrl) payload.origin_url = videoUrl;
          if (animationUrl) payload.anim_url = animationUrl;

          formData.append("payload", JSON.stringify(payload));
          if (videoFile) formData.append("video", videoFile);
          if (animationFile) formData.append("animation", animationFile);

          setResponse({ status: "Uploading", tone: "info", body: "Sending request..." });

          const res = await fetch("/api/clips", { method: "POST", body: formData });
          const text = await res.text();

          try {
            const parsed = JSON.parse(text);
            setResponse({
              status: res.ok ? `Success (${res.status})` : `Error (${res.status})`,
              tone: res.ok ? "success" : "error",
              bodyNode: renderResponsePayload(parsed),
            });
          } catch (_) {
            setResponse({
              status: res.ok ? `Success (${res.status})` : `Error (${res.status})`,
              tone: res.ok ? "success" : "error",
              body: text,
            });
          }
        } catch (error) {
          setResponse({
            status: "Error",
            tone: "error",
            body: error instanceof Error ? error.message : String(error),
          });
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Upload Clips";
        }
      });
    </script>
  </body>
</html>
